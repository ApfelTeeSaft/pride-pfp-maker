<!DOCTYPE html>
<html>
    <head>
        <title>Pride PFP Maker</title>
        <meta charset='utf-8'>
        <meta name='viewport' content='width=device-width, initial-scale=0.5'> <!-- should be good for most phones ? -->

        <link rel='stylesheet' href='src/index.css'>
        <link rel='shortcut icon' href='src/assets/favicon.png' type='image/png'>

        <meta name='description' content='customize your PFPs with pride flags !'>
        <meta name='keywords' content='pride, pride pfp maker, pride icon maker, pride month, pride pfp, pride flag ring icon'>
        <meta name='author' content='github.com/nectarboy'>

        <!-- PfpPride scripts -->
        <script src='src/pfppride/pfppride.js'></script>
        <script src='src/pfppride/presetflags.js'></script>
        <script src='src/pfppride/editor.js'></script>
    </head>

    <body>

        <!-- Top bar -->
        <div class='topBar'>
            <div class='topSub'> <!-- stfu -->
                <span class='topTitle'>
                    <img src='src/assets/logo_24.png'>
                    Pride PFP Maker |
                </span>
                <span class='topDesc'>customize your PFPs with pride flags ! v0.6</span>
                <br>

                <marquee><span id='prideAlertMuthaFucka' class='prideText'></span></marquee>
                <script>
                    if ((new Date()).getMonth() === 5)
                        document.getElementById('prideAlertMuthaFucka').innerHTML = 'happy pride month '.repeat(12); // 13 ?

                    // if u see this ur gay as balls
                </script>
            </div>
        </div>
        <br>

        <!-- Main dividers -->
        <div class='outerBox'>

            <!-- Upload div -->
            <div id='uploadDiv' class='mainBox' style='display: none'>
                <div class='bigLayer' style='overflow-y: hidden'>
                    <span>
                        drap and drop an image !<br>
                        (or click that icon)
                    </span>
                    <hr class='line'>

                    <!-- Upload image -->
                    <div class='centerImgFrame'>
                        <span class='centerImgHelper'></span>

                        <input type='file' id='uploadButton' style='display: none'>
                        <label for='uploadButton'>
                            <img src='src/assets/upload.png' id='uploadButton' class='centerImg uploadImg' draggable='false'>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Export div -->
            <div id='exportDiv' class='mainBox' style='display: none'>
                <div class='bigLayer' style='overflow-y: hidden'>
                    <span>
                        right click and save the image !<br>
                        (tap and hold if on mobile)
                    </span>
                    <hr class='line'>

                    <div id='continueEditing' class='button otherFlagButton'>
                        <span>Continue Editing</span>
                    </div>

                    <!-- Upload image -->
                    <div class='centerImgFrame'>
                        <span class='centerImgHelper'></span>
                        <img id='exportEl' class='exportImg'>
                    </div>
                </div>
            </div>

            <!-- Editor div -->
            <div id='editorDiv' class='mainBox' style='display: none'>
                <table class='editorTable'>
                    <tr>
                        <!-- Left side -->
                        <td class='leftSide'>
                        <div class='sideWrap'>

                            <!-- Preview -->
                            <div class='mediumLayer'>
                                <span>
                                    this is your profile pic !<br>
                                    drag it to move the image position !
                                </span>
                                <hr class='line'>

                                <canvas id='mainCanvas' class='pfpPreview' width='500' height='500'></canvas>
                            </div>
                            <br>

                            <!-- Flag Select -->
                            <div class='smallLayer'>
                                <span>change the pride flag !</span>
                                <hr class='line'>

                                <!-- fuck tables >:( -->
                                <div id='flagButtonDiv' class='flagButtonDiv'>
                                    <!-- Custom flag image input -->
                                    <input type='file' id='otherFlagInput' style='display: none'>
                                </div>
                            </div>

                        </div>
                        </td>

                        <!-- Right side -->
                        <td class='rightSide'>
                        <div class='sideWrap'>
                            
                            <!-- Settings -->
                            <div class='bigLayer'>
                                <div class='exportDivWrapper'>
                                    <span>more settings !</span>
                                    <hr class='line'>

                                    <div>
                                        <!-- Image scale -->
                                        <span>image scale</span>
                                        <br>
                                        <input type='range' id='imgScaleInput' class='slider' min='0' max='3' step='0.05'>
                                        <br>

                                        <!-- Ring scale -->
                                        <span>ring scale</span>
                                        <br>
                                        <input type='range' id='ringScaleInput' class='slider' min='0' max='1' step='0.025'>
                                        <br>
                                    </div>

                                    <!-- Export settings and stuff -->
                                    <div class='exportDiv'>
                                        <div>
                                            <button id='chooseNewButton' class='button newImgButton'>Choose New Image</button>

                                            <div style='height: 12px'></div>

                                            <button id='exportButton' class='button greenButton'>Export and Open Image</button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                        </td>
                    </tr>
                </table>
            </div>

        </div>
        <br>

        <div style='text-align: center'>
            <span class='topDesc'>nectarboy | 2021 | <a class='topDesc' href='https://github.com/nectarboy/pride-pfp-maker/'>source</a></span>
        </div>

        <!-- Index script ( INDEX.JS !!!??) -->
        <script>
            console.log('what u doing sneakin around in the code huh ...');

            // --- get all elements
            const mainCanvas = document.getElementById('mainCanvas');
            const mainCtx = mainCanvas.getContext('2d');

            const uploadDiv = document.getElementById('uploadDiv');
                const uploadButton = document.getElementById('uploadButton');

            const exportDiv = document.getElementById('exportDiv');
                const continueEditing = document.getElementById('continueEditing');
                const exportEl = document.getElementById('exportEl');

            const editorDiv = document.getElementById('editorDiv');
                const flagButtonDiv = document.getElementById('flagButtonDiv');
                const otherFlagInput = document.getElementById('otherFlagInput');
                const imgScaleInput = document.getElementById('imgScaleInput');
                const ringScaleInput = document.getElementById('ringScaleInput');
                const chooseNewButton = document.getElementById('chooseNewButton');
                const exportButton = document.getElementById('exportButton');

            var currentDiv = uploadDiv;

            // --- helper functions
            function selectDiv(div) {
                currentDiv.style.display = 'none';

                currentDiv = div;
                currentDiv.style.display = 'inherit';
            }

            function loadImgFromFile(file, callback) {
                const img = new Image();
                img.onload = () => callback(img);
                img.onerror = () => alert('bitch the fuck did u give me !');

                img.src = URL.createObjectURL(file); // set src to blob url
            }

            function onPfpUpload(img) {
                resetEditor();

                editor.loadPfpImg(img);
                editor.refreshCanvas();
                defaultInputValues();

                selectDiv(editorDiv);
            }

            function defaultInputValues() {
                imgScaleInput.value = editor.pfpImgScale;
                ringScaleInput.value = 1 - editor.pfpRingScale;

                console.log(imgScaleInput.value, ringScaleInput.value);
            }

            function getCanvasUrl(canvas) {
                return mainCanvas.toDataURL('image/png').replace('image/png', 'image/octet-stream');
            }

            var refreshing = false;
            const refreshCool = 25;
            function requestRefresh() {
                if (refreshing)
                    return;
                refreshing = true;

                setTimeout(() => {
                    refreshing = false;
                    editor.refreshCanvas();
                }, refreshCool);
            }

            // editor
            var editor = null;
            function resetEditor() {
                editor = new Editor(mainCanvas);
                editor.flagId = 1; // Gay flag
            }

            // --- editing
            // generate flag buttons
            for (var i = 0; i < presetFlags.length; i++) {
                // create elements
                const wrapper = document.createElement('div');
                const div = document.createElement('div');
                const span = document.createElement('span');

                // generate text
                const canv = document.createElement('canvas');
                    canv.width = canv.height = 24;
                    canv.style.border = '1px solid white';
                    presetFlags[i].obj.DrawFlagOnCanvas(canv);

                const title = document.createElement('span');
                    title.innerHTML = presetFlags[i].name + '<br>';

                span.appendChild(title);
                span.appendChild(canv);

                div.className = 'button flagButton';
                wrapper.className = 'flagButtonWrapper';

                // append all elements
                div.appendChild(span);
                wrapper.appendChild(div);
                flagButtonDiv.appendChild(wrapper);

                // button functionality
                (function(ii) {
                    div.onclick = function() {
                        editor.clearFlagImg();

                        editor.flagId = ii;
                        editor.refreshCanvas();
                    };
                })(i);
            }

            // generate other flag upload button
            otherFlagInput.onchange = function() {
                if (this.files && this.files[0]) {
                    loadImgFromFile(this.files[0], img => {
                        editor.loadFlagImg(img);
                        editor.refreshCanvas();
                    });
                }
            };

            (function() {
                // create elements
                const wrapper = document.createElement('div');
                const label = document.createElement('label');
                const div = document.createElement('div');

                label.htmlFor = 'otherFlagInput';

                div.className = 'button otherFlagButton';
                div.innerHTML = 'Custom<br>Image';
                wrapper.className = 'flagButtonWrapper';

                // append all elements
                label.appendChild(div);
                wrapper.appendChild(label);
                flagButtonDiv.appendChild(wrapper);
            })();

            // more settings
            imgScaleInput.oninput = function() {
                editor.pfpImgScale = this.value;
                requestRefresh();
            };

            ringScaleInput.oninput = function() {
                editor.pfpRingScale = 1 - this.value;
                requestRefresh();
            };

            // export buttons
            chooseNewButton.onclick = function() {
                if (confirm('are you sure you want to start over ?'))
                    selectDiv(uploadDiv);
            };

            exportButton.onclick = function() {
                // download as file method - ehh
                // window.open(
                //     getCanvasUrl(mainCanvas),
                //     '_blank'
                // );

                // let user manually save - better for phones ig :,3
                exportEl.onload = function() {
                    selectDiv(exportDiv);
                };

                exportEl.onerror = () => alert('there was an error exporting ! try again ? o_o;');

                exportEl.src = getCanvasUrl(mainCanvas);
                
            };

            // --- uploading
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                  uploadDiv.addEventListener(eventName, function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });

            uploadDiv.ondrop = function(e) {
                const files = e.dataTransfer.files;
                if (files && files[0])
                    loadImgFromFile(files[0], onPfpUpload);
            };

            // button click
            uploadButton.onchange = function() {
                if (this.files && this.files[0])
                    loadImgFromFile(this.files[0], onPfpUpload);
            };

            // --- exporting
            continueEditing.onclick = function() {
                selectDiv(editorDiv);

                exportEl.onerror = null;
                exportEl.src = ''; // unneeded !
            };

            // --- execute
            selectDiv(uploadDiv);

            console.log('no errors :D');

        </script>

    </body>
</html>